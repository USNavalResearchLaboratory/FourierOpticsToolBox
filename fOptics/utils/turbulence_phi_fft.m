function [phi] = turbulence_phi_fft(D,r0,K)% generates a phase screen with Komolgorov statistics via FFT techniques%% phi = turbulence_phi_fft(D,r0,K)%% phi = generated phase screen% D = dimensions of phi (default = 128)% r0 = Fried's parameter in units of pixels (default = 128)% K = number of subharmonic sets to include in fix for low spatial%      frequencies%% ref: RG Lane, A Glindemann, and JC Dainty, "Simulation of a Komolgorov%      phase screen," Waves in Random Media vol. 2, 209-224 (1992).%% sam thurman% sept. 5, 2006arguments    D= 2048*2  % default dimension of output array    r0 = D % default Fried parameter    K = 5endN = 2*D; % dimensions of bigger arraydn = 1/N; % Fourier domain sample spacing[n2,n1] = meshgrid(dn*fftshift(-N/2:N/2-1)); % Fourier domain sample coordinatesr = sqrt(n1.^2+n2.^2); % radial coordinater(1) = 1; % to fix singularity at originphi = sqrt(dn^2*0.023*r0^(-5/3)*r.^(-11/3)).*(randn(N)+1j*randn(N)); % square root of Komolgorov power spectrum%subplot(221); imagesc(fftshift(abs(phi).^0.1));phi = fftshift(real(fftn(phi))); % phase screen%axis square; subplot(222); imagesc(phi)phi = phi(N/2-round(D/2)+[1:D],N/2-round(D/2)+[1:D]); % crop output out of bigger array%subplot(223); imagesc(phi); %subplot(2,2,2); axis square; imagesc(phi)% fix for inadequately sampled low spatial frequencies of power spectrumns1 = []; % subharmonic sample coordinatesns2 = [];dns = []; % subharmonic sample spacingsfor k = 1:K    dn = dn/3;    [tmp2,tmp1] = meshgrid(dn*[-1,0,1]);    ns1 = [ns1;tmp1(:)];    ns2 = [ns2;tmp2(:)];    dns = [dns;repmat(dn,[9,1])];endrs = sqrt(ns1.^2+ns2.^2); % subharmonic radial coordinates[d2,d1] = meshgrid(1:D); % phase screen domain sample coordinatesticfor sub = 1:9*K     if rs(sub)>0 % add each subharmonic contribution        phi = phi+sqrt(dns(sub)^2*0.023*r0^(-5/3)*rs(sub)^(-11/3))*real((randn(1)+1j*randn(1))*exp(-1i*2*pi*(ns1(sub)*d1+ns2(sub)*d2)));    endendtoc%subplot(2,2,3); imagesc(phi);phi = phi-mean(phi(:));%subplot(224); imagesc(phi); % remove piston from phase screen%subplot(2,2,4); imagesc(phi);end